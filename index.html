<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Rob√¥ Falante - Vers√£o Linux Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; margin: 10px; width: 80%; max-width: 300px; }
        .btn-conectar { background-color: #007bff; color: white; }
        .btn-falar { background-color: #28a745; color: white; }
        .btn-teste { background-color: #ffc107; color: black; font-weight: bold; }
        textarea { width: 80%; height: 100px; font-size: 18px; margin: 20px 0; padding: 10px; }
        #status { margin-top: 20px; font-weight: bold; color: #555; }
        
        #debug-log {
            margin-top: 30px;
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            text-align: left;
            height: 250px;
            overflow-y: scroll;
            border-radius: 5px;
            border: 2px solid #555;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <h1>ü§ñ Rob√¥ Falante (Linux Fix)</h1>

    <button class="btn-conectar" onclick="conectarBluetooth()">1. Conectar Bluetooth</button>
    <br>
    
    <div id="status">Status: Desconectado</div>
    
    <textarea id="textoFala" placeholder="Digite aqui o que o rob√¥ vai falar..."></textarea>
    <br>
    
    <button class="btn-falar" onclick="falar()">2. Falar e Mexer</button>
    <br>
    <button class="btn-teste" onclick="testeDireto()">3. Teste R√°pido (Envia '3')</button>

    <h3>Painel de Debug:</h3>
    <div id="debug-log">Aguardando...</div>

    <script>
        let dispositivoBluetooth;
        let caracteristicaEscrita;
        
        // UUIDs Padr√£o Nordic UART
        const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const UART_RX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // RX (Micro:bit recebe)

        function log(msg) {
            const logDiv = document.getElementById('debug-log');
            const linha = document.createElement('div');
            const hora = new Date().toLocaleTimeString();
            linha.innerText = `[${hora}] ${msg}`;
            logDiv.appendChild(linha);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function conectarBluetooth() {
            try {
                log("Iniciando busca...");
                document.getElementById('status').innerText = "Status: Procurando...";
                
                dispositivoBluetooth = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "BBC micro:bit" }],
                    optionalServices: [UART_SERVICE_UUID]
                });

                log("Conectando ao GATT Server...");
                const servidor = await dispositivoBluetooth.gatt.connect();
                
                log("Obtendo Servi√ßo UART...");
                const servico = await servidor.getPrimaryService(UART_SERVICE_UUID);
                
                log("Obtendo Caracter√≠stica de Escrita (RX)...");
                caracteristicaEscrita = await servico.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);

                // --- DIAGN√ìSTICO DE PROPRIEDADES ---
                log("üîé Analisando permiss√µes do Micro:bit:");
                let props = [];
                if (caracteristicaEscrita.properties.write) props.push("WRITE (Com Resposta)");
                if (caracteristicaEscrita.properties.writeWithoutResponse) props.push("WRITE NO RESPONSE (Sem Resposta)");
                log("Permiss√µes encontradas: " + props.join(", "));

                document.getElementById('status').innerText = "Status: CONECTADO! üü¢";
                document.getElementById('status').style.color = "green";
                
            } catch (error) {
                log("‚ùå FALHA CONEX√ÉO: " + error);
                document.getElementById('status').innerText = "Erro: " + error;
            }
        }

        function contarSilabas(palavra) {
            if (!palavra) return 0;
            palavra = palavra.toLowerCase();
            if(palavra.length <= 3) return 1;
            palavra = palavra.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
            palavra = palavra.replace(/^y/, '');
            const silabas = palavra.match(/[aeiouy]{1,2}/g);
            return silabas ? silabas.length : 1;
        }

        async function enviarParaMicrobit(numero) {
            if (!caracteristicaEscrita) {
                log("‚ö†Ô∏è N√£o conectado.");
                return;
            }

            try {
                let encoder = new TextEncoder();
                let dados = encoder.encode(numero.toString());
                
                log(`Enviando '${numero}'...`);

                // --- A CORRE√á√ÉO M√ÅGICA PARA LINUX ---
                // Verifica qual m√©todo de escrita est√° dispon√≠vel
                if (caracteristicaEscrita.properties.writeWithoutResponse) {
                    await caracteristicaEscrita.writeValueWithoutResponse(dados);
                    log("‚úÖ Enviado via 'WriteWithoutResponse' (R√°pido)");
                } else {
                    await caracteristicaEscrita.writeValue(dados);
                    log("‚úÖ Enviado via 'Write' (Padr√£o)");
                }
                
            } catch (error) {
                log("‚ùå ERRO FATAL: " + error);
                log("Tente reiniciar o Micro:bit.");
            }
        }

        async function falar() {
            let texto = document.getElementById("textoFala").value;
            if (!texto) return;

            let numSilabas = contarSilabas(texto);
            await enviarParaMicrobit(numSilabas);

            let fala = new SpeechSynthesisUtterance(texto);
            fala.lang = "pt-BR";
            fala.rate = 1.0; 
            window.speechSynthesis.speak(fala);
        }

        async function testeDireto() {
            await enviarParaMicrobit(3);
        }
    </script>
</body>
</html>
